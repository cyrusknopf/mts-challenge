services:
  postgresql:
    image: postgres:14
    platform: linux/amd64
    container_name: postgresql
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "l??pT-87pBqE2hN9-zY/)"
      POSTGRES_DB: "prism"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./prism-postgres_init:/docker-entrypoint-initdb.d
    networks:
      - prismnetwork
    ports:
      - "5432:5432"

  prism-server:
    image: cyrusknopf/prism-server:latest
    build:
      context: ./prism-server
      args:
        POSTGRES_PWD: "l??pT-87pBqE2hN9-zY/)"
    platform: linux/amd64
    container_name: prism-server
    # runtime: nvidia # Requires NVIDIA Container Toolkit on the host for GPU access
    environment:
      NVIDIA_VISIBLE_DEVICES: all
      POSTGRES_PWD: "l??pT-87pBqE2hN9-zY/)"
    volumes:
      - ./prism-server_data:/workspace/data
      - ./prism-server:/workspace/src
    ports:
      - "8082:8082"
    networks:
      - prismnetwork
    stdin_open: true # Keeps STDIN open (like -i)
    tty: true # Allocates a TTY (like -t)

   prism-website:
     build: ./prism-website
     platform: linux/amd64
     container_name: prism-website
     volumes:
       - ./prism-website:/usr/src/app
     environment:
       - NODE_ENV=production
     ports:
       - "3000:3000"
     networks:
       - prismnetwork
     stdin_open: true # Keeps STDIN open (like -i)
     tty: true # Allocates a TTY (like -t)
     restart: always
  
volumes:
  pgdata:

networks:
  prismnetwork:
    driver: bridge
